<?php

namespace Middleware\LaravelApm;

use Illuminate\Support\ServiceProvider;
use Middleware\LaravelApm\Commands\ExportMetrics;
use OpenTelemetry\API\Trace\TracerProviderInterface;
use OpenTelemetry\API\Logs\LoggerProviderInterface;
use OpenTelemetry\API\Metrics\MeterProviderInterface;
use OpenTelemetry\SDK\Common\Export\Http\PsrTransportFactory;
use OpenTelemetry\SDK\Trace\TracerProvider;
use OpenTelemetry\SDK\Logs\LoggerProvider;
use OpenTelemetry\SDK\Metrics\MeterProvider;
use OpenTelemetry\SDK\Trace\SpanProcessor\SimpleSpanProcessor;
use OpenTelemetry\SDK\Logs\Processor\SimpleLogRecordProcessor as LogProcessor;
use OpenTelemetry\Contrib\Otlp\SpanExporter;
use OpenTelemetry\Contrib\Otlp\LogsExporter;
use OpenTelemetry\Contrib\Otlp\MetricExporter;
use OpenTelemetry\SDK\Metrics\MetricReader\ExportingReader;
use OpenTelemetry\SDK\Resource\ResourceInfoFactory;
use OpenTelemetry\SDK\Common\Attribute\Attributes;
use OpenTelemetry\SDK\Resource\ResourceInfo;
use OpenTelemetry\SemConv\ResourceAttributes;
use OpenTelemetry\SDK\Metrics\Data\Temporality;
use Illuminate\Support\Facades\Log;
use GuzzleHttp\Psr7\HttpFactory as GuzzleHttpFactory;
use OpenTelemetry\SDK\Common\Export\TransportFactoryInterface;

class LaravelApmServiceProvider extends ServiceProvider
{

    private $contentType;
    private $headers;

    private $endpoint;

    public function register()
    {
        // Check if OpenTelemetry SDK is disabled
        if (getenv('OTEL_SDK_DISABLED') === 'true') {
            // Register empty implementations
            $this->app->singleton(TracerProviderInterface::class, function ($app) {
                return new \OpenTelemetry\API\Trace\NoopTracerProvider();
            });

            $this->app->singleton(LoggerProviderInterface::class, function ($app) {
                return new \OpenTelemetry\API\Logs\NoopLoggerProvider();
            });

            $this->app->singleton(MeterProviderInterface::class, function ($app) {
                return new \OpenTelemetry\API\Metrics\Noop\NoopMeterProvider();
            });

            $this->app->singleton(ExportingReader::class, function ($app) {
                // Create a mock ExportingReader that does nothing
                return new class implements \OpenTelemetry\SDK\Metrics\MetricReaderInterface {
                    public function collect(): bool
                    {
                        return true;
                    }
                    public function shutdown(): bool
                    {
                        return true;
                    }
                    public function forceFlush(): bool
                    {
                        return true;
                    }
                };
            });

            $this->app->singleton('laravel-apm', function ($app) {
                return new LaravelApm(
                    $app->make(TracerProviderInterface::class),
                    $app->make(LoggerProviderInterface::class),
                    $app->make(MeterProviderInterface::class),
                    $app->make(ExportingReader::class)
                );
            });

            return;
        }

        $this->endpoint = getenv("OTEL_EXPORTER_OTLP_ENDPOINT") ?: getenv("MW_TARGET") ?: 'http://localhost:4318';

        $protocol = getenv("OTEL_EXPORTER_OTLP_PROTOCOL", 'http/json');
        $ct = '';

        switch ($protocol) {
            case 'http/json':
                $ct = 'application/json';
                break;

            case 'http/protobuf':
                $ct = "application/x-protobuf";
                break;

            case 'grpc':
                $ct = "application/grpc";
                break;

            default:
                $ct = 'application/json';
                break;
        }

        $this->contentType = $ct;
        $this->headers = [
            'Content-Type' => 'application/json'
        ];

        $this->app->singleton(ExportingReader::class, function ($app) {
            $transportFactory = $this->getTransportFactory();

            $transport = $transportFactory->create($this->endpoint . '/v1/metrics', $this->contentType, $this->headers);

            $exporter = new MetricExporter($transport, Temporality::CUMULATIVE);

            return new ExportingReader($exporter);
        });

        $this->app->singleton(MetricsManager::class, function ($app) {
            return new MetricsManager($app->make(MeterProviderInterface::class));
        });

        $this->app->singleton(TracerProviderInterface::class, function ($app) {
            return $this->createTracerProvider();
        });

        $this->app->singleton(LoggerProviderInterface::class, function ($app) {
            return $this->createLoggerProvider();
        });

        $this->app->singleton(MeterProviderInterface::class, function ($app) {
            return $this->createMeterProvider();
        });


        $this->app->singleton('laravel-apm', function ($app) {
            return new LaravelApm(
                $app->make(TracerProviderInterface::class),
                $app->make(LoggerProviderInterface::class),
                $app->make(MeterProviderInterface::class),
                $app->make(ExportingReader::class)
            );
        });
    }

    public function boot()
    {
        try {
            if ($this->app->runningInConsole()) {
                $this->commands([
                    ExportMetrics::class,
                ]);
            }

            $this->configureLogging();
            $this->app['router']->aliasMiddleware('apm-metrics', \Middleware\LaravelApm\Middleware\MetricsMiddleware::class);

            $this->app->terminating(function () {
                try {
                    $apm = $this->app->make('laravel-apm');
                    $apm->exportMetrics();
                } catch (\Exception $e) {
                    // Silently ignore OpenTelemetry export errors
                    Log::debug('OpenTelemetry export failed: ' . $e->getMessage());
                }
            });

            $this->app['router']->aliasMiddleware('apm-metrics', \Middleware\LaravelApm\Middleware\MetricsMiddleware::class);
            $this->app['router']->aliasMiddleware('apm-tracing', \Middleware\LaravelApm\Middleware\TracingMiddleware::class);
        } catch (\Exception $e) {
            Log::error('Failed to boot Laravel APM service provider: ' . $e->getMessage(), ['trace' => $e->getTraceAsString()]);
        }
    }

    private function createTracerProvider()
    {
        $transportFactory = $this->getTransportFactory();

        $transport = $transportFactory->create($this->endpoint . '/v1/traces', $this->contentType, $this->headers);

        $exporter = new SpanExporter($transport);

        $spanProcessor = new SimpleSpanProcessor($exporter);

        $serviceName = getenv("OTEL_SERVICE_NAME") ?: getenv('MW_SERVICE_NAME') ?: 'service-' . getmypid();

        return TracerProvider::builder()
            ->addSpanProcessor($spanProcessor)
            ->setResource(ResourceInfoFactory::emptyResource()->merge(ResourceInfo::create(Attributes::create([
                ResourceAttributes::SERVICE_NAME => $serviceName,
            ]))))
            ->build();
    }

    private function createLoggerProvider()
    {
        $transportFactory = $this->getTransportFactory();

        $transport = $transportFactory->create($this->endpoint . '/v1/logs', $this->contentType, $this->headers);

        $exporter = new LogsExporter($transport);

        $serviceName = getenv("OTEL_SERVICE_NAME") ?: getenv('MW_SERVICE_NAME') ?: 'service-' . getmypid();

        return LoggerProvider::builder()
            ->addLogRecordProcessor(new LogProcessor($exporter))
            ->setResource(ResourceInfoFactory::emptyResource()->merge(ResourceInfo::create(Attributes::create([
                ResourceAttributes::SERVICE_NAME => $serviceName,
            ]))))
            ->build();
    }

    private function createMeterProvider()
    {
        $reader = $this->app->make(ExportingReader::class);

        $serviceName = getenv("OTEL_SERVICE_NAME") ?: getenv('MW_SERVICE_NAME') ?: 'service-' . getmypid();

        return MeterProvider::builder()
            ->addReader($reader)
            ->setResource(ResourceInfoFactory::emptyResource()->merge(ResourceInfo::create(Attributes::create([
                ResourceAttributes::SERVICE_NAME => $serviceName,
            ]))))
            ->build();
    }


    private function configureLogging()
    {
        $loggerProvider = $this->app->make(LoggerProviderInterface::class);
        $otelHandler = new \OpenTelemetry\Contrib\Logs\Monolog\Handler($loggerProvider, 'debug');
        Log::pushHandler($otelHandler);
    }

    protected function createHttpFactories(): array
    {
        // if (class_exists(LaravelHttpFactory::class)) {
        //     $factory = new LaravelHttpFactory();
        //     return [
        //         'client' => $factory->buildClient(),
        //         'requestFactory' => $factory,
        //         'streamFactory' => $factory,
        //     ];
        // }

        if (class_exists(GuzzleHttpFactory::class)) {
            $factory = new GuzzleHttpFactory();
            return [
                'client' => new \GuzzleHttp\Client(),
                'requestFactory' => $factory,
                'streamFactory' => $factory,
            ];
        }

        \Illuminate\Support\Facades\Log::error('MW: No suitable HTTP factories found. Please install Guzzle or use Laravel 8.0+');

        // Return empty factories as fallback
        return [
            'client' => new \GuzzleHttp\Client(),
            'requestFactory' => new GuzzleHttpFactory(),
            'streamFactory' => new GuzzleHttpFactory(),
        ];
    }

    private function getTransportFactory(): TransportFactoryInterface
    {
        $factories = $this->createHttpFactories();

        return new PsrTransportFactory(
            $factories['client'],
            $factories['requestFactory'],
            $factories['streamFactory']
        );
    }
}
